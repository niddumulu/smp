<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Encrypt / Decrypt TXT</title>
<style>
body { font-family: Arial; padding: 20px; }
.box { margin-bottom: 30px; padding: 15px; border: 1px solid #ccc; }
</style>
</head>
<body>

<h2>üîê ENKRIPSI TXT ‚Üí FILE TERENKRIPSI</h2>
<div class="box">
    <textarea id="plainText" placeholder="Masukkan teks yang ingin dienkripsi" style="width:100%;height:120px;"></textarea><br><br>
    <input type="text" id="encKey" placeholder="Masukkan password / key" style="width:100%;"><br><br>
    <button onclick="encryptNow()">Encrypt</button>
</div>

<h2>üîì DEKRIPSI FILE TERENKRIPSI</h2>
<div class="box">
    <input type="file" id="encFile"><br><br>
    <input type="text" id="decKey" placeholder="Masukkan password / key" style="width:100%;"><br><br>
    <button onclick="decryptNow()">Decrypt</button>
    <p id="decryptedResult"></p>
</div>

<script>
// Convert Base64 <-> Uint8Array
function b64ToBytes(b64) {
    const bin = atob(b64);
    const arr = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
    return arr;
}
function bytesToB64(bytes) {
    let bin = "";
    bytes.forEach(b => bin += String.fromCharCode(b));
    return btoa(bin);
}

// ====================== ENCRYPT ======================
async function encryptNow() {
    const text = document.getElementById("plainText").value;
    const password = document.getElementById("encKey").value;

    if (!text || !password) {
        alert("Teks dan key wajib diisi.");
        return;
    }

    const enc = new TextEncoder().encode(text);
    const pw = new TextEncoder().encode(password);

    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));

    const baseKey = await crypto.subtle.importKey("raw", pw, "PBKDF2", false, ["deriveKey"]);
    const key = await crypto.subtle.deriveKey(
        { name: "PBKDF2", salt, iterations: 200000, hash: "SHA-256" },
        baseKey,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt"]
    );

    const cipher = new Uint8Array(await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, enc));

    const output = {
        salt: bytesToB64(salt),
        iv: bytesToB64(iv),
        data: bytesToB64(cipher)
    };

    const blob = new Blob([JSON.stringify(output)], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "encrypted.txt";
    a.click();
}

// ====================== DECRYPT ======================
async function decryptNow() {
    const fileInput = document.getElementById("encFile").files[0];
    const password = document.getElementById("decKey").value;

    if (!fileInput || !password) {
        alert("File dan key wajib diisi.");
        return;
    }

    const reader = new FileReader();
    reader.onload = async function () {
        try {
            const obj = JSON.parse(reader.result);

            const salt = b64ToBytes(obj.salt);
            const iv = b64ToBytes(obj.iv);
            const cipher = b64ToBytes(obj.data);

            const pw = new TextEncoder().encode(password);
            const baseKey = await crypto.subtle.importKey("raw", pw, "PBKDF2", false, ["deriveKey"]);

            const key = await crypto.subtle.deriveKey(
                { name: "PBKDF2", salt, iterations: 200000, hash: "SHA-256" },
                baseKey,
                { name: "AES-GCM", length: 256 },
                false,
                ["decrypt"]
            );

            const plain = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, cipher);
            const text = new TextDecoder().decode(plain);

            document.getElementById("decryptedResult").innerText = "Hasil dekripsi:\n" + text;
        } catch (e) {
            alert("Gagal mendekripsi. Password salah atau file rusak.");
        }
    };

    reader.readAsText(fileInput);
}
</script>
</body>
</html>