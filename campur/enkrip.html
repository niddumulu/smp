<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Encrypt / Decrypt TXT — Final</title>
<style>
  :root{--bg:#f6f8fb;--card:#ffffff;--primary:#0b78a3;--muted:#667}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#0b1220;padding:18px}
  .card{max-width:960px;margin:18px auto;padding:20px;border-radius:10px;background:var(--card);box-shadow:0 8px 30px rgba(10,20,40,0.06)}
  h1{margin:0 0 6px;font-size:20px}
  p.lead{margin:0 0 14px;color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:10px 0}
  label{font-size:14px;color:#233}
  input[type="file"]{font-size:13px}
  input[type="text"], input[type="password"], textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;font-family:monospace}
  .half{flex:1;min-width:240px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{padding:8px 12px;border-radius:8px;border:0;background:var(--primary);color:white;cursor:pointer}
  button.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,120,163,0.12)}
  small{color:var(--muted)}
  pre{background:#0f1724;color:#dff6ee;padding:10px;border-radius:8px;overflow:auto;white-space:pre-wrap}
  .note{background:#fff7e6;padding:8px;border-radius:6px;border:1px solid #ffe5b4;color:#6a4b00}
  .switch{display:inline-flex;align-items:center;gap:8px}
  .inline{display:inline-block}
</style>
</head>
<body>
<main class="card">
  <h1>Encrypt / Decrypt TXT — Final</h1>
  <p class="lead">Semua proses terjadi di browser (client-side). Enkripsi: AES-GCM (256). Kamu bisa gunakan key Base64 atau passphrase (PBKDF2).</p>

  <!-- ENCRYPT -->
  <section>
    <h2>Encrypt</h2>

    <div class="row">
      <label class="half">Pilih file TXT untuk dienkripsi
        <input id="fileToEnc" type="file" accept=".txt,text/plain">
      </label>

      <div style="min-width:220px">
        <button id="genKeyBtn" type="button">Generate Random Key (Base64)</button>
      </div>
    </div>

    <div class="row">
      <label class="half">Gunakan Passphrase (opsional)
        <input id="usePassphrase" type="checkbox" /> <small>Centang untuk gunakan passphrase (jangan isi Key Base64 simultan)</small>
      </label>

      <div style="min-width:220px">
        <button id="encryptBtn" type="button">Encrypt & Download</button>
      </div>
    </div>

    <div class="row">
      <label class="half">Key (Base64) — atau kosongkan jika pakai passphrase / ingin generate
        <input id="keyField" type="text" placeholder="Isi dengan raw key Base64 (opsional)" />
      </label>

      <label class="half">Passphrase (jika centang di atas)
        <input id="passField" type="password" placeholder="Masukkan passphrase jika dipakai" />
      </label>
    </div>

    <div class="row controls">
      <button id="copyKeyBtn" class="ghost" type="button">Copy Key ke Clipboard</button>
      <button id="clearEncBtn" class="ghost" type="button">Clear Fields</button>
      <small>Output file: <code>nama_file.enc.txt</code> (JSON: filename, iv, ciphertext[, salt])</small>
    </div>
  </section>

  <hr>

  <!-- DECRYPT -->
  <section>
    <h2>Decrypt</h2>

    <div class="row">
      <label class="half">Pilih file enkripsi (.enc.txt atau file JSON apa pun)
        <input id="fileToDec" type="file">
      </label>

      <label class="half">Key (Base64) atau Passphrase (jika file menyertakan <code>salt</code>)
        <input id="decKeyField" type="text" placeholder="Masukkan key Base64 atau passphrase" />
      </label>
    </div>

    <div class="row controls">
      <button id="decryptBtn" type="button">Decrypt & Download</button>
      <button id="previewBtn" class="ghost" type="button">Preview (tanpa download)</button>
      <button id="clearDecBtn" class="ghost" type="button">Clear</button>
      <small>Pilih file apa pun — dekoder akan mendeteksi field <code>ciphertext</code> atau <code>cipher</code>.</small>
    </div>

    <div id="previewArea" style="margin-top:14px;display:none">
      <strong>Preview isi:</strong>
      <pre id="previewText"></pre>
    </div>
  </section>

  <hr>
  <section>
    <h3>Catatan penting</h3>
    <p class="note">
      - Jangan push key atau passphrase ke repo publik. <br>
      - Jika menggunakan passphrase, file enkripsi menyimpan <code>salt</code> — itu perlu untuk derivasi kembali saat dekripsi. <br>
      - Jika file enkripsi dibuat dengan key (raw Base64), masukkan key yang sama saat dekripsi.
    </p>
  </section>
</main>

<script>
/* -------------------- Utilities -------------------- */
function toBase64(arrBuf){
  const bytes = new Uint8Array(arrBuf instanceof ArrayBuffer ? arrBuf : arrBuf.buffer || arrBuf);
  let bin = "";
  const chunk = 0x8000;
  for(let i=0;i<bytes.length;i+=chunk){
    bin += String.fromCharCode.apply(null, Array.from(bytes.subarray(i, i+chunk)));
  }
  return btoa(bin);
}
function base64ToBytes(b64){
  const bin = atob(b64);
  const n = bin.length;
  const arr = new Uint8Array(n);
  for(let i=0;i<n;i++) arr[i] = bin.charCodeAt(i);
  return arr;
}
function arrayBufferToUint8(arrBuf){
  return arrBuf instanceof Uint8Array ? arrBuf : new Uint8Array(arrBuf);
}

async function generateRawAesKey(){
  const k = await crypto.subtle.generateKey({name:"AES-GCM", length:256}, true, ["encrypt","decrypt"]);
  const raw = await crypto.subtle.exportKey("raw", k);
  return {key:k, raw};
}

async function importRawKeyFromBase64(b64){
  const bytes = base64ToBytes(b64).buffer;
  return crypto.subtle.importKey("raw", bytes, "AES-GCM", true, ["encrypt","decrypt"]);
}

async function deriveKeyFromPassphrase(pass, saltBytes){
  // PBKDF2 -> AES-GCM 256
  const pwBytes = new TextEncoder().encode(pass);
  const base = await crypto.subtle.importKey("raw", pwBytes, "PBKDF2", false, ["deriveKey"]);
  const key = await crypto.subtle.deriveKey(
    {name:"PBKDF2", salt: saltBytes, iterations: 200000, hash:"SHA-256"},
    base,
    {name:"AES-GCM", length:256},
    true,
    ["encrypt","decrypt"]
  );
  return key;
}

/* -------------------- DOM -------------------- */
const fileToEnc = document.getElementById("fileToEnc");
const genKeyBtn = document.getElementById("genKeyBtn");
const usePassphrase = document.getElementById("usePassphrase");
const keyField = document.getElementById("keyField");
const passField = document.getElementById("passField");
const encryptBtn = document.getElementById("encryptBtn");
const copyKeyBtn = document.getElementById("copyKeyBtn");
const clearEncBtn = document.getElementById("clearEncBtn");

const fileToDec = document.getElementById("fileToDec");
const decKeyField = document.getElementById("decKeyField");
const decryptBtn = document.getElementById("decryptBtn");
const previewBtn = document.getElementById("previewBtn");
const previewArea = document.getElementById("previewArea");
const previewText = document.getElementById("previewText");
const clearDecBtn = document.getElementById("clearDecBtn");

/* -------------------- Handlers -------------------- */
genKeyBtn.addEventListener("click", async () => {
  try{
    const {raw} = await generateRawAesKey();
    const b64 = toBase64(raw);
    keyField.value = b64;
    alert("Key (Base64) generated. Simpan di tempat aman.");
  }catch(e){ alert("Gagal generate key: " + e.message); }
});

copyKeyBtn.addEventListener("click", async () => {
  const v = keyField.value.trim();
  if(!v) return alert("Belum ada key untuk disalin.");
  try{ await navigator.clipboard.writeText(v); alert("Key disalin ke clipboard."); }
  catch(e){ alert("Gagal salin: " + e.message); }
});

clearEncBtn.addEventListener("click", () => {
  keyField.value = "";
  passField.value = "";
  fileToEnc.value = "";
  usePassphrase.checked = false;
});

clearDecBtn.addEventListener("click", () => {
  decKeyField.value = "";
  fileToDec.value = "";
  previewArea.style.display = "none";
  previewText.textContent = "";
});

/* --------------- ENCRYPT --------------- */
encryptBtn.addEventListener("click", async () => {
  const file = fileToEnc.files[0];
  if(!file) return alert("Pilih file .txt untuk dienkripsi.");

  const usePass = usePassphrase.checked;
  const providedKeyB64 = keyField.value.trim();
  const pass = passField.value;

  if(usePass && !pass) return alert("Centang 'Use Passphrase' dan isi passphrase.");
  if(!usePass && !providedKeyB64){ /* we'll generate automatically */ }

  try{
    let cryptoKey;
    let keyB64 = providedKeyB64 || null;
    let saltB64 = null;

    if(usePass){
      // derive key from passphrase: generate salt and include it in JSON
      const salt = crypto.getRandomValues(new Uint8Array(16));
      saltB64 = toBase64(salt);
      cryptoKey = await deriveKeyFromPassphrase(pass, salt);
      // do not populate keyField (we expect passphrase)
    } else {
      if(!keyB64){
        const {key, raw} = await generateRawAesKey();
        cryptoKey = key;
        keyB64 = toBase64(raw);
        keyField.value = keyB64;
      } else {
        cryptoKey = await importRawKeyFromBase64(keyB64);
      }
    }

    const plainBuf = await file.arrayBuffer();
    const iv = crypto.getRandomValues(new Uint8Array(12)); // 96-bit IV
    const cipherBuf = await crypto.subtle.encrypt({name:"AES-GCM", iv}, cryptoKey, plainBuf);

    // output JSON
    const out = {
      filename: file.name,
      iv: toBase64(iv),
      ciphertext: toBase64(cipherBuf)
    };
    if(saltB64) out.salt = saltB64;

    const blob = new Blob([JSON.stringify(out)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = file.name.replace(/\.txt$/i,"") + ".enc.txt";
    a.click();
    URL.revokeObjectURL(a.href);

    alert("File terenkripsi. Simpan file .enc.txt dan simpan key / passphrase dengan aman.");
  }catch(err){
    alert("Gagal enkripsi: " + (err && err.message ? err.message : err));
    console.error(err);
  }
});

/* --------------- DECRYPT --------------- */
decryptBtn.addEventListener("click", async () => {
  const file = fileToDec.files[0];
  if(!file) return alert("Pilih file enkripsi (.enc.txt atau JSON).");

  const provided = decKeyField.value.trim();
  if(!provided) return alert("Masukkan key Base64 atau passphrase di field sebelah.");

  try{
    const text = await file.text();
    let obj;
    try{ obj = JSON.parse(text); } catch(e){ throw new Error("File bukan JSON atau rusak."); }

    // Detect ciphertext field (support 'ciphertext' or 'cipher')
    const cipherB64 = obj.ciphertext || obj.cipher || obj.data;
    if(!cipherB64) throw new Error("Field ciphertext tidak ditemukan di file.");

    const ivB64 = obj.iv;
    if(!ivB64) throw new Error("Field iv tidak ditemukan di file.");

    // Determine key: if salt present in file -> derive from passphrase; else expect raw key Base64
    let cryptoKey;
    if(obj.salt){
      // expect user provided passphrase
      const saltBytes = base64ToBytes(obj.salt);
      cryptoKey = await deriveKeyFromPassphrase(provided, saltBytes);
    } else {
      // expect raw key Base64
      cryptoKey = await importRawKeyFromBase64(provided);
    }

    const iv = base64ToBytes(ivB64);
    const cipher = base64ToBytes(cipherB64);

    let plainBuf;
    try{
      plainBuf = await crypto.subtle.decrypt({name:"AES-GCM", iv: iv}, cryptoKey, cipher);
    }catch(e){
      throw new Error("Dekripsi gagal — kemungkinan key/passphrase salah atau data rusak.");
    }

    // prepare download
    const outName = (obj.filename ? obj.filename.replace(/\.txt$/i,"") + ".dec.txt" : "decrypted.txt");
    const blob = new Blob([plainBuf], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = outName;
    a.click();
    URL.revokeObjectURL(a.href);

    alert("File berhasil didekripsi dan di-download.");
  }catch(err){
    alert("Gagal dekripsi: " + (err && err.message ? err.message : err));
    console.error(err);
  }
});

/* --------------- PREVIEW --------------- */
previewBtn.addEventListener("click", async () => {
  const file = fileToDec.files[0];
  if(!file) return alert("Pilih file enkripsi untuk preview.");
  const provided = decKeyField.value.trim();
  if(!provided) return alert("Masukkan key Base64 atau passphrase.");

  try{
    const text = await file.text();
    let obj;
    try{ obj = JSON.parse(text); } catch(e){ throw new Error("File bukan JSON atau rusak."); }

    const cipherB64 = obj.ciphertext || obj.cipher || obj.data;
    if(!cipherB64) throw new Error("Field ciphertext tidak ditemukan di file.");
    const ivB64 = obj.iv;
    if(!ivB64) throw new Error("Field iv tidak ditemukan di file.");

    let cryptoKey;
    if(obj.salt){
      cryptoKey = await deriveKeyFromPassphrase(provided, base64ToBytes(obj.salt));
    } else {
      cryptoKey = await importRawKeyFromBase64(provided);
    }

    const iv = base64ToBytes(ivB64);
    const cipher = base64ToBytes(cipherB64);

    const plainBuf = await crypto.subtle.decrypt({name:"AES-GCM", iv: iv}, cryptoKey, cipher);
    const txt = new TextDecoder().decode(plainBuf);
    previewText.textContent = txt;
    previewArea.style.display = "block";
  }catch(err){
    alert("Preview gagal: " + (err && err.message ? err.message : err));
    console.error(err);
  }
});
</script>
</body>
</html>